const Config={validation:{email:{regex:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,messages:{required:"请输入邮箱地址",invalid:"请输入有效的邮箱地址"}},password:{minLength:6,maxLength:32,messages:{required:"请输入密码",minLength:"密码至少需要6个字符",maxLength:"密码不能超过32个字符"}},nickname:{minLength:2,maxLength:20,messages:{required:"请输入昵称",minLength:"昵称至少需要2个字符",maxLength:"昵称不能超过20个字符"}},verificationCode:{length:6,messages:{required:"请输入验证码",invalid:"验证码应为6位数字"}}},api:{baseUrl:"https://api.akihafield.com",endpoints:{login:"/auth/login",register:"/auth/register",forgotPassword:"/auth/forgot-password",resetPassword:"/auth/reset-password"}}};class FormValidator{validateEmail(e){return e?Config.validation.email.regex.test(e)?{isValid:!0}:{isValid:!1,message:Config.validation.email.messages.invalid}:{isValid:!1,message:Config.validation.email.messages.required}}validatePassword(e){return e?e.length<Config.validation.password.minLength?{isValid:!1,message:Config.validation.password.messages.minLength}:e.length>Config.validation.password.maxLength?{isValid:!1,message:Config.validation.password.messages.maxLength}:{isValid:!0}:{isValid:!1,message:Config.validation.password.messages.required}}validateNickname(e){return e?e.length<Config.validation.nickname.minLength?{isValid:!1,message:Config.validation.nickname.messages.minLength}:e.length>Config.validation.nickname.maxLength?{isValid:!1,message:Config.validation.nickname.messages.maxLength}:{isValid:!0}:{isValid:!1,message:Config.validation.nickname.messages.required}}validateVerificationCode(e){return e?/^\d{6}$/.test(e)?{isValid:!0}:{isValid:!1,message:Config.validation.verificationCode.messages.invalid}:{isValid:!1,message:Config.validation.verificationCode.messages.required}}}class PasswordStrengthChecker{checkStrength(e){if(!e)return{level:"weak",percentage:0,text:"弱",class:"weak",color:"#e74c3c"};let t=0;const s=[{test:/.{8,}/,weight:25},{test:/[a-z]/,weight:15},{test:/[A-Z]/,weight:15},{test:/[0-9]/,weight:15},{test:/[^a-zA-Z0-9]/,weight:15},{test:/.{12,}/,weight:15}];s.forEach(n=>{n.test.test(e)&&(t+=n.weight)}),t=Math.min(t,100);const n=[{min:0,max:40,text:"弱",class:"weak",color:"#e74c3c"},{min:40,max:70,text:"一般",class:"medium",color:"#f39c12"},{min:70,max:100,text:"强",class:"strong",color:"#2ecc71"}],o=n.find(e=>t>=e.min&&t<=e.max)||n[0];return{...o,percentage:t}}updateUI(e,t="password-strength",n="strength-text"){const s=this.checkStrength(e),o=document.querySelector(`#${t} .strength-bar`),i=document.getElementById(n);return o&&(o.className="strength-bar",o.classList.add(s.class),o.style.width=`${s.percentage}%`,o.style.backgroundColor=s.color),i&&(i.textContent=`密码强度：${s.text}`,i.style.color=s.color),s}}class FormHandler{constructor(e){this.form=document.getElementById(e),this.validator=new FormValidator,this.passwordChecker=new PasswordStrengthChecker,this.isSubmitting=!1,this.init()}init(){this.setupEventListeners(),this.setupCustomCheckboxes()}setupEventListeners(){this.form.addEventListener("submit",this.handleSubmit.bind(this)),this.form.addEventListener("input",this.handleInput.bind(this)),this.form.addEventListener("keypress",e=>{e.key==="Enter"&&!this.isSubmitting&&this.form.requestSubmit()})}setupCustomCheckboxes(){const e=this.form.querySelectorAll('input[type="checkbox"]');e.forEach(e=>{e.addEventListener("change",()=>{this.validateCheckboxes()})})}handleInput(e){const t=e.target.name||e.target.id.replace(/^(login|register|forgot)-/,"");this.validateField(t,e.target.value)}validateField(e,t){let n;switch(e){case"email":n=this.validator.validateEmail(t);break;case"password":n=this.validator.validatePassword(t);break;case"nickname":n=this.validator.validateNickname(t);break;default:return}this.updateFieldUI(e,n)}updateFieldUI(e,t,n=""){const i=n?`${n}-${e}`:`${this.form.id.replace("-form","")}-${e}`,s=document.getElementById(i),o=document.getElementById(`${i}-error`);if(!s||!o)return;s.classList.remove("valid","invalid"),t.isValid?(s.classList.add("valid"),this.hideError(o)):(s.classList.add("invalid"),this.showError(o,t.message))}showError(e,t){e&&(e.textContent=t,e.classList.add("show"))}hideError(e){e&&(e.textContent="",e.classList.remove("show"))}validateCheckboxes(){const e=document.querySelector('input[name="agreement1"]'),t=document.querySelector('input[name="agreement2"]'),n=document.querySelector('input[name="register-agreement1"]'),s=document.querySelector('input[name="register-agreement2"]');if(e&&t){const n=document.getElementById("login-agreement-error");!e.checked||!t.checked?this.showError(n,"请同意所有协议"):this.hideError(n)}if(n&&s){const e=document.getElementById("register-agreement-error");!n.checked||!s.checked?this.showError(e,"请同意所有协议"):this.hideError(e)}}setSubmitButton(e,t="提交"){const n=this.form.querySelector('button[type="submit"]');if(!n)return;e?(n.disabled=!0,n.innerHTML='<span class="loading"></span> 提交中...'):(n.disabled=!1,n.textContent=t)}showMessage(e,t){const s=document.querySelectorAll(".toast");s.forEach(e=>e.remove());const n=document.createElement("div");n.className=`toast toast-${t}`,n.textContent=e,n.Text=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${t==="success"?"#27ae60":"#e74c3c"};
            color: white;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        `,document.body.appendChild(n),setTimeout(()=>{document.body.contains(n)&&(n.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>{document.body.contains(n)&&document.body.removeChild(n)},300))},3e3)}validateAllFields(){let e=!0;const t=this.form.querySelectorAll('input[type="text"], input[type="email"], input[type="password"]');t.forEach(t=>{const s=t.name||t.id.replace(/^(login|register|forgot)-/,"");this.validateField(s,t.value);const n=document.getElementById(`${t.id}-error`);n&&n.classList.contains("show")&&(e=!1)}),this.validateCheckboxes();const n=this.form.querySelector(".error-message.show");return n&&(e=!1),e}async handleSubmit(e){if(e.preventDefault(),this.isSubmitting)return;const t=this.validateAllFields();if(!t){this.showMessage("请检查表单中的错误","error");return}this.isSubmitting=!0,this.setSubmitButton(!0);try{await this.submitFormData(),this.showMessage("操作成功！","success"),this.form.reset(),await this.handleFormSuccess()}catch(e){console.error("表单提交错误:",e),this.showMessage("提交失败，请重试","error")}finally{this.isSubmitting=!1,this.setSubmitButton(!1)}}async submitFormData(){return new Promise((e,t)=>{setTimeout(()=>{Math.random()<.1?t(new Error("网络错误")):e()},1500)})}async handleFormSuccess(){const e=this.form.id;e==="register-form"&&setTimeout(()=>{showLoginPage()},1e3),e==="login-form"&&setTimeout(()=>{window.location.href="/index.html"},1e3)}}class RegisterFormHandler extends FormHandler{constructor(e){super(e)}init(){super.init(),this.setupPasswordStrength(),this.setupRealTimePasswordValidation()}setupPasswordStrength(){const e=this.form.querySelector("#register-password");e&&e.addEventListener("input",e=>{this.passwordChecker.updateUI(e.target.value)})}setupRealTimePasswordValidation(){const e=this.form.querySelector("#register-password"),t=this.form.querySelector("#register-confirm-password");e&&t&&(e.addEventListener("input",e=>{this.validatePasswordMatch(),this.passwordChecker.updateUI(e.target.value)}),t.addEventListener("input",()=>{this.validatePasswordMatch()}))}validatePasswordMatch(){const n=this.form.querySelector("#register-password"),e=this.form.querySelector("#register-confirm-password"),i=document.getElementById("register-password-error"),s=document.getElementById("register-confirm-password-error");if(!n||!e)return;const o=n.value,t=e.value;n.classList.remove("invalid"),e.classList.remove("invalid"),this.hideError(i),this.hideError(s),t&&o!==t&&(e.classList.add("invalid"),this.showError(s,"两次输入的密码不一致")),o&&!t&&this.showError(s,"请确认密码"),o&&t&&o===t&&(n.classList.add("valid"),e.classList.add("valid"),this.hideError(s))}validateAllFields(){let n=super.validateAllFields();const e=this.form.querySelector("#register-password"),t=this.form.querySelector("#register-confirm-password"),s=document.getElementById("register-confirm-password-error");return e&&t&&e.value&&t.value&&e.value!==t.value&&(this.showError(s,"两次输入的密码不一致"),n=!1),n}}class ForgotPasswordHandler extends FormHandler{constructor(e){super(e)}init(){super.init(),this.setupPasswordStrength(),this.setupRealTimePasswordValidation()}setupPasswordStrength(){const e=document.getElementById("new-password");e&&e.addEventListener("input",e=>{this.passwordChecker.updateUI(e.target.value,"new-password-strength","new-strength-text")})}setupRealTimePasswordValidation(){const e=document.getElementById("new-password"),t=document.getElementById("confirm-new-password");e&&t&&(e.addEventListener("input",()=>{this.validatePasswordMatch()}),t.addEventListener("input",()=>{this.validatePasswordMatch()}))}validatePasswordMatch(){const n=document.getElementById("new-password"),e=document.getElementById("confirm-new-password"),i=document.getElementById("new-password-error"),s=document.getElementById("confirm-new-password-error");if(!n||!e)return;const o=n.value,t=e.value;n.classList.remove("invalid"),e.classList.remove("invalid"),this.hideError(i),this.hideError(s),t&&o!==t&&(e.classList.add("invalid"),this.showError(s,"两次输入的密码不一致")),o&&!t&&this.showError(s,"请确认密码"),o&&t&&o===t&&(n.classList.add("valid"),e.classList.add("valid"),this.hideError(s))}validateAllFields(){let e=!0;const t=new FormValidator,r=document.getElementById("forgot-email").value,s=t.validateEmail(r);this.updateFieldUI("email",s,"forgot"),s.isValid||(e=!1);const c=document.getElementById("verification-code").value,o=t.validateVerificationCode(c);this.updateFieldUI("verification-code",o),o.isValid||(e=!1);const n=document.getElementById("new-password").value,i=document.getElementById("confirm-new-password").value,a=t.validatePassword(n);return this.updateFieldUI("new-password",a),a.isValid||(e=!1),n&&i&&n!==i&&(this.showError(document.getElementById("confirm-new-password-error"),"两次输入的密码不一致"),e=!1),e}async handleSubmit(e){if(e.preventDefault(),this.isSubmitting)return;const t=this.validateAllFields();if(!t){this.showMessage("请检查表单中的错误","error");return}this.isSubmitting=!0,this.setSubmitButton(!0,"重置密码");try{await this.submitFormData(),this.showSuccessMessage(),this.form.reset()}catch{this.showMessage("重置密码失败，请重试","error")}finally{this.isSubmitting=!1,this.setSubmitButton(!1,"重置密码")}}showSuccessMessage(){const e=this.form.closest(".form-container"),t=`
            <div class="success-message">
                <div class="success-icon">✓</div>
                <h3>密码重置成功！</h3>
                <p>您的密码已成功重置，请使用新密码登录。</p>
                <button type="button" class="btn btn-login" onclick="showLoginPage()">立即登录</button>
            </div>
        `;e.innerHTML=t}}class AuthApp{constructor(){this.init()}init(){this.initializeForms(),this.setupPageSwitching(),this.setupForgotPassword(),this.setupBackToTop(),this.addCSRFToken()}initializeForms(){document.getElementById("login-form")&&new FormHandler("login-form"),document.getElementById("register-form")&&new RegisterFormHandler("register-form"),document.getElementById("forgot-password-form")&&new ForgotPasswordHandler("forgot-password-form")}setupPageSwitching(){window.showRegisterPage=()=>{this.animatePageTransition("login-page","register-page")},window.showLoginPage=()=>{const e=document.getElementById("register-page").style.display!=="none"?"register-page":"forgot-password-page";this.animatePageTransition(e,"login-page")},window.showForgotPasswordPage=()=>{this.animatePageTransition("login-page","forgot-password-page")}}animatePageTransition(e,t){const s=document.getElementById(e),n=document.getElementById(t);if(!s||!n)return;s.style.opacity="0",s.style.transform="translateX(-20px)",setTimeout(()=>{s.style.display="none",n.style.display="block",n.style.opacity="0",n.style.transform="translateX(20px)",setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(0)"},50)},300)}setupForgotPassword(){const e=document.getElementById("send-code-btn");e&&e.addEventListener("click",this.handleSendVerificationCode.bind(this))}handleSendVerificationCode(){const n=document.getElementById("forgot-email"),e=n.value,s=document.getElementById("send-code-btn"),o=new FormValidator,t=o.validateEmail(e);if(!t.isValid){this.showMessage(t.message,"error");return}this.startCountdown(s),console.log(`向 ${e} 发送验证码`),this.showMessage("验证码已发送到您的邮箱，请查收","success"),setTimeout(()=>{this.showMessage("模拟验证码：123456","success")},1e3)}startCountdown(e){let t=60;e.disabled=!0,e.textContent=`${t}秒后重新发送`;const n=setInterval(()=>{t--,e.textContent=`${t}秒后重新发送`,t<=0&&(clearInterval(n),e.disabled=!1,e.textContent="发送验证码")},1e3)}setupBackToTop(){const e=document.querySelector(".back-to-top");e&&(window.addEventListener("scroll",()=>{window.scrollY>300?e.classList.add("visible"):e.classList.remove("visible")}),e.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}))}addCSRFToken(){const e=document.querySelectorAll("form");e.forEach(e=>{const n=this.generateCSRFToken(),t=document.createElement("input");t.type="hidden",t.name="csrf_token",t.value=n,e.appendChild(t)})}generateCSRFToken(){return Math.random().toString(36).substring(2)+Date.now().toString(36)}showMessage(e,t){const n=document.createElement("div");n.className=`toast toast-${t}`,n.textContent=e,n.Text=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${t==="success"?"#27ae60":"#e74c3c"};
            color: white;
            border-radius: 4px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        `,document.body.appendChild(n),setTimeout(()=>{document.body.contains(n)&&(n.style.animation="slideOutRight 0.3s ease-in",setTimeout(()=>{document.body.contains(n)&&document.body.removeChild(n)},300))},3e3)}}const style=document.createElement("style");style.textContent=`
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
`,document.head.appendChild(style),document.addEventListener("DOMContentLoaded",()=>{new AuthApp});function showRegisterPage(){document.getElementById("login-page").style.display="none",document.getElementById("register-page").style.display="block",document.getElementById("forgot-password-page").style.display="none"}function showLoginPage(){document.getElementById("register-page").style.display="none",document.getElementById("login-page").style.display="block",document.getElementById("forgot-password-page").style.display="none"}function showForgotPasswordPage(){document.getElementById("login-page").style.display="none",document.getElementById("register-page").style.display="none",document.getElementById("forgot-password-page").style.display="block"}